#!/bin/bash

repos=("brooke" "schoch")

borg_repos=({% for host in ("brooke.okfn.de", "schoch.okfn.de") %}"ssh://{{ light_sync.repo[host].user }}@{{ light_sync.repo[host].host }}:{{ light_sync.repo[host].port }}/{{ light_sync.repo[host].path }}" {% endfor %})
borg_repokeys=("{{ light_sync.repo["brooke.okfn.de"].pass }}" "{{ light_sync.repo["schoch.okfn.de"].pass }}")

ssh_port="{{ ssh_port }}"

brooke_ip="192.168.122.123"
schoch_ip="192.168.122.240"
restore_mountpoint="/mnt"

brooke_restoredir="false"

cd /root/light_sync

start_docker(){
    echo "Start docker container"
    docker run -d --name backup-light-postgres -e psql=psql -e POSTGRES_HOST_AUTH_METHOD=trust -p 127.0.0.1:5432:5432 "postgis/postgis:16-3.4"
    echo "Wait for postgres start"
    sleep 10
}

shutdown_docker(){
    echo "Shutdown docker container"
    docker stop backup-light-postgres
}

mount_backups(){
    for i in ${!repos[@]}; do
        repo=${repos[$i]}
        echo "Mount ${repo} backup"
        mkdir -p ${restore_mountpoint}/borg/${repo}

        BORG_PASSPHRASE=${borg_repokeys[$i]} borg --bypass-lock mount --last 1 "${borg_repos[$i]}" /mnt/borg/${repo}
        restoredir=$(ls "/mnt/borg/${repo}")
        echo ${restoredir}
    done

    mkdir -p ${restore_mountpoint}/backup-light/db
    brooke_restoredir=$(ls "${restore_mountpoint}/borg/brooke")
}

get_db(){
    if [ ! -f backup_light.sql ]; then
        echo "db backup file ${sqldate}"
        echo "Create database"
        createdb -h localhost -p 5432 -U postgres -O postgres fragdenstaat_de
        echo "Import backup"
        gunzip -k -c /mnt/borg/brooke/${brooke_restoredir}/var/www/fragdenstaat.de/backup/sqlbackup-${sqldate}.sql.gz | psql -h localhost -p 5432 -U postgres fragdenstaat_de

        echo "Create light dump"
        pg_dump -h localhost -U postgres fragdenstaat_de --schema-only > schema.sql
        curl 'https://raw.githubusercontent.com/okfde/fragdenstaat_de/main/scripts/create_light_sql.py' > create_light_sql.py
        curl 'https://raw.githubusercontent.com/okfde/fragdenstaat_de/main/scripts/safe_tables.txt' > safe_tables.txt
        curl 'https://raw.githubusercontent.com/okfde/fragdenstaat_de/main/scripts/safe_fks.txt' > safe_fks.txt
        python3 create_light_sql.py generate --source_connection="-h localhost -U postgres" --target_connection="-h localhost -p 5432 -U postgres" > make_light.sh
        bash make_light.sh
        pg_dump -h localhost -p 5432 -U postgres fragdenstaat_de_light > backup_light.sql
    else
        echo "Reusing existing backup_light.sql..."
    fi
}

restore_db(){
    echo "Import db on brooke-tst"
    echo "Stop services"
    ssh ${brooke_ip} -p ${ssh_port} "sudo supervisorctl stop all"
    echo "Copy database dump"
    scp -P ${ssh_port} ./backup_light.sql ${brooke_ip}:/tmp/
    echo "Set access rights for dump"
    ssh ${brooke_ip} -p ${ssh_port} "sudo chown postgres:root /tmp/backup_light.sql"
    ssh ${brooke_ip} -p ${ssh_port} "sudo chmod 0640 /tmp/backup_light.sql"
    echo "Drop old db"
    ssh ${brooke_ip} -p ${ssh_port} "sudo -u postgres dropdb fragdenstaat_de"
    echo "Create new db"
    ssh ${brooke_ip} -p ${ssh_port} "sudo -u postgres createdb -O fragdenstaat_de fragdenstaat_de"
    echo "Import dump"
    ssh ${brooke_ip} -p ${ssh_port} "sudo -u postgres psql -d fragdenstaat_de -a -f /tmp/backup_light.sql"
    echo "Delete dump file"
    ssh ${brooke_ip} -p ${ssh_port} "rm /tmp/backup_light.sql"
    echo "Start services"
    ssh ${brooke_ip} -p ${ssh_port} "sudo supervisorctl start all"
}

get_db_files(){
    echo "Copy ${2}"
    for i in $(echo "${1}" | psql -U postgres -h localhost -p 5432 fragdenstaat_de_light | grep "${1}/" | awk '{$1=$1};1'); do
        dir="$(dirname "${i}")"
        file="$(basename "${i}")"
        mkdir -p ./media/${dir}
        source=$(echo "${i}" | sed "s|${2}/|/mnt/borg/schoch/${schoch_restoredir}/home/storage-box/home/files/${2}/|g")
        echo "${source} - ./media/${dir}/${file}"
        cp "${source}" ./media/${dir}/${file}
    done
}

get_files(){
    echo "Get media files"
    schoch_restoredir=$(ls "/mnt/borg/schoch")
    mkdir ./media
    mount /dev/vg0/media /root/light_sync/media
    get_db_files "SELECT DISTINCT pdf_file FROM document_document" "docs"
    get_db_files "SELECT image, image_large, image_normal, image_small FROM filingcabinet_page" "docs"
    get_db_files "SELECT file FROM foirequest_foiattachment" "foi"
    get_db_files "SELECT DISTINCT document FROM froide_legalaction_proposaldocument" "legalaction"
    get_db_files "SELECT DISTINCT profile_photo FROM account_user" "profile"

    echo "Get static files"
    dirs=("campaign" "cms_page_media" "contractor" "media" "orglogo")
    for i in ${dirs[@]}; do
        echo "${i}"
        mkdir -p ./media/${i}
        rsync -rav /mnt/borg/schoch/${schoch_restoredir}/home/storage-box/home/files/${i}/* ./media/${i}/
    done
}

restore_files(){
    echo "Copy files to schoch-tst"
    ssh ${schoch_ip} -p ${ssh_port} "mkdir -p /home/storage-box/home/files/"
    rsync -rav -e "ssh -p ${ssh_port}" "./media/" "${schoch_ip}:/home/storage-box/home/files/"
    echo "Set file owner/group"
    ssh ${schoch_ip} -p ${ssh_port} "chown fragdenstaat_de:www-data -R /home/storage-box/home/files/"
}

cleanup(){
    echo "Cleanup"

    for repo in ${repos[@]}; do
        echo "Unmount ${repo} backup"
        umount /mnt/borg/${repo}
    done

    umount /root/light_sync/media
    rm ./*.sql
}

cleanup_only() {
    shutdown_docker
    cleanup
    exit 0
}

usage(){
cat << EOF
Usage: $0
   [ -h | --help ]          Display this help
   [ -d | --db ]            Don't restore the database on brooke-tst (default: false)
   [ -f | --files ]         Don't get files from backup (default: false)
   [ -c | --copy ]          Don't copy files to brooke-tst (default: false)
   [ -s | --date input ]    Use date input as sql backup filename (e.g. 2024-02-11, default: current date)
   [ -u | --cleanup ]       Cleanup only (remove docker container, unmount backup, remove tempfiles)
EOF
exit 1
}

args=$(getopt -a -o dfcus:h --long db,files,copy,cleanup,date:,help -- "$@")
if [[ $? -gt 0 ]]; then
  usage
fi

eval set -- ${args}
while :
do
  case $1 in
    -d | --db)       db=false     ; shift   ;;
    -f | --files)    files=false  ; shift   ;;
    -h | --help)     usage        ; shift   ;;
    -c | --copy)     copy=false   ; shift   ;;
    -u | --cleanup)  cleanup_only ; shift   ;;
    -s | --date)     sqldate=$2   ; shift 2 ;;

    --) shift; break ;;
    *) usage ;;
  esac
done

if [ -z ${copy} ]; then
    copy=true
fi
if [ -z ${db} ]; then
    db=true
fi
if [ -z ${files} ]; then
    files=true
fi
if [ -z ${sqldate} ]; then
    sqldate=$(date -d "yesterday 00:01" +"%Y-%m-%d")
fi

if [ ${db} == "true" ] || [ ${files} == "true" ]; then
    start_docker
    mount_backups
    get_db
fi
if [ ${db} == "true" ]; then
    restore_db
fi
if [ ${files} == "true" ]; then
    get_files
fi
if [ ${copy} == "true" ]; then
    restore_files
fi
if [ ${db} == "true" ] || [ ${files} == "true" ]; then
    shutdown_docker
fi
if [ ${db} == "true" ] || [ ${files} == "true" ] || [ ${copy} == "true" ]; then
    cleanup
fi

if [ ${db} == "false" ] && [ ${files} == "false" ] && [ ${copy} == "false" ]; then
    echo "Nothing to do..."
    exit 2
fi

exit 0
